// INSTRUCTIONS: Replace the handleSubmit function in src/app/tree-form/page.tsx
// Find the function starting around line 334 and replace it with this entire function

const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  if (!user || !auth || !screenshotFile || !iAgree) {
    let message = "An unknown error occurred.";
    if (!user) message = "You must be logged in to submit.";
    else if (!screenshotFile) message = "Please upload a transaction screenshot.";
    else if (!iAgree) message = "Please agree to the consent statement.";

    toast({
      variant: "destructive",
      title: "Submission Error",
      description: message,
    });
    return;
  }

  setIsSubmitting(true);

  try {
    console.log("Starting submission process...");
    console.log("User UID:", user.uid);
    console.log("User Email:", user.email);
    console.log("Email Verified:", user.emailVerified);

    // Ensure user has a fresh auth token
    const idToken = await user.getIdToken(true);
    console.log("Fresh ID token obtained");

    // 1. Upload Screenshot to Google Drive
    const submissionId = uuidv4();
    
    console.log(`Uploading file to Google Drive...`);
    console.log(`File size: ${screenshotFile.size} bytes`);
    console.log(`File type: ${screenshotFile.type}`);

    // Create FormData for file upload
    const uploadFormData = new FormData();
    uploadFormData.append('file', screenshotFile);
    uploadFormData.append('submissionId', submissionId);
    uploadFormData.append('userId', user.uid);

    let downloadURL: string;
    try {
      const uploadResponse = await fetch('/api/upload-to-drive', {
        method: 'POST',
        body: uploadFormData,
      });

      if (!uploadResponse.ok) {
        const errorData = await uploadResponse.json();
        throw new Error(errorData.error || 'Failed to upload to Google Drive');
      }

      const uploadResult = await uploadResponse.json();
      downloadURL = uploadResult.fileUrl;
      console.log("File upload successful to Google Drive");
      console.log("File URL:", downloadURL);
    } catch (uploadError: any) {
      console.error("Google Drive upload error:", uploadError);
      throw new Error(`File upload failed: ${uploadError.message}`);
    }

    // 2. Prepare Submission Data
    const submissionData = {
      firstName,
      middleName,
      lastName,
      email,
      phone,
      address,
      pan,
      plantingOption,
      otherTrees,
      dedication,
      oneTreeOption,
      bundlePlanOption,
      lifetimePlanOption,
      donationOption,
      otherDonationAmount,
      verificationChoice,
      contributionMode,
      contributionFrequency,
      finalContributionAmount,
      transactionId,
      screenshotURL: downloadURL,
      userId: user.uid,
      userEmail: user.email,
      submittedAt: new Date(),
      status: 'pending',
      submissionId: submissionId,
      totalAmount: totalAmount
    };

    // 3. Save to Firestore
    if (!firestore) throw new Error("Firestore not initialized");

    console.log("Writing submission to Firestore...");
    console.log("Submission ID:", submissionId);
    
    try {
      await setDoc(doc(firestore, 'submissions', submissionId), submissionData);
      console.log("Firestore write successful");
    } catch (firestoreError: any) {
      console.error("Firestore write error:", firestoreError);
      throw new Error(`Firestore write failed: ${firestoreError.message}`);
    }

    // 4. Clear saved form data
    try {
      const draftRef = doc(firestore, `users/${user.uid}/drafts/tree-form`);
      await setDoc(draftRef, {});
      console.log("Draft cleared from Firestore");
    } catch (cleanupError) {
      console.warn("Failed to clear cloud draft (non-critical):", cleanupError);
    }

    localStorage.removeItem(`treeFormData_${user.uid}`);
    console.log("Draft cleared from localStorage");

    toast({
      title: "Submission Successful",
      description: "Your form has been submitted successfully.",
    });

    router.push('/thank-you');

  } catch (error: any) {
    console.error("Submission error:", error);
    console.error("Error code:", error?.code);
    console.error("Error message:", error?.message);
    console.error("Full error:", JSON.stringify(error, null, 2));
    
    let errorMessage = error?.message || "Unknown error";
    
    // Provide more specific error messages
    if (error?.code === 'permission-denied') {
      errorMessage = "Permission denied. Please ensure you're logged in with a verified email.";
    } else if (error?.message?.includes('File upload failed')) {
      errorMessage = error.message;
    } else if (error?.message?.includes('Firestore write failed')) {
      errorMessage = error.message;
    }

    toast({
      variant: "destructive",
      title: "Submission Failed",
      description: errorMessage,
    });
  } finally {
    setIsSubmitting(false);
  }
};
